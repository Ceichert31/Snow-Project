name: Deploy to Quest
on:
  workflow_run:
    workflows: ["Build Unity VR"]
    types: [completed]
    branches: [main]
  workflow_dispatch:  #Allow manual deployment
    inputs:
      run_id:
        description: 'Build run ID to deploy (leave empty for latest)'
        required: false

        

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: VR-Android-Build-${{ github.event.workflow_run.head_sha || github.sha }}
          path: ./build

      - name: Setup ADB
        run: sudo apt-get update && sudo apt-get install -y android-tools-adb

      #Connect to quest and turn off automated sleep
      - name: Disable Quest auto-sleep
        env:
          QUEST_IP: ${{ secrets.QUEST_IP }}
        run: |
          echo "::add-mask::$QUEST_IP"
          adb connect $QUEST_IP:5555
          sleep 2
          adb -s $QUEST_IP:5555 shell svc power stayon true
          echo "Quest auto-sleep disabled"

      - name: Deploy to Quest
        env:
          QUEST_IP: ${{ secrets.QUEST_IP }}
        run: |
          echo "Connecting to Quest at $QUEST_IP..."
          adb connect $QUEST_IP:5555
          sleep 5

          #Check connection status
          CONNECTED_DEVICES=$(adb devices | grep "$QUEST_IP:5555")

          #If not connected, tell user
          if [ -z "$CONNECTED_DEVICES" ]; then
          echo "Failed to connect to Quest at port 5555"
          echo ""
          echo "Troubleshooting steps:"
          echo "1. Ensure your Quest is on the same network as the runner"
          echo "2. Enable Developer Mode on your Quest"
          echo "3. Connect Quest via USB cable to your computer and run:"
          echo "   adb tcpip 5555"
          echo "4. Verify the Quest IP is correct"
          echo "5. Try connecting manaually, <quest_ip>:5555"
          echo ""
          echo "Current ADB devices:"
          adb devices
          exit 1
          fi
    
          echo "Successfully connected to Quest"
          adb devices
          
          #Find the APK file
          APK_FILE=$(find ./build -name "*.apk" | head -n 1)
          
          if [ -z "$APK_FILE" ]; then
          echo "Error: No APK file found"
          exit 1
          fi
          
          echo "Installing $APK_FILE..."
          adb -s $QUEST_IP:5555 install -r "$APK_FILE"
          
          echo "Deployment complete!"

      #Re-enable sleep settings after deployment
      - name: Enable Quest auto-sleep
        if: always()
        env:
          QUEST_IP: ${{ secrets.QUEST_IP }}
        run: |
          echo "::add-mask::$QUEST_IP"
          adb -s $QUEST_IP:5555 shell svc power stayon false || true
